<div align="center">

<h4>Министерство образования, науки и молодежной политики Республики Коми</h4>
<h4>ГПОУ «Сыктывкарский политехнический техникум»</h4>

<br>

<h2>Курсовая работа</h2>

<br>

<h2>Разработка БД агентства по аренде квартир</h2>

<br>

</div>

<br><br>

<div align="right">

<b>выполнил:</b><br>
студент 4 курса<br>
414 группы<br>
Кочанов Александр Максимович

<br><br>

<b>проверил:</b><br>
Пунгин И.В.

<br><br>

<b>дата проверки:</b> ___________

</div>

<br><br><br>

<div align="center">
Сыктывкар, 2025 г.

</div>

---

<h2>Содержание</h2>

<ul>
  <li><a href="#введение">Введение</a></li>
  <li>
    <a href="#1-анализ-предметной-области-постановка-задачи">
      1. Анализ предметной области. Постановка задачи
    </a>
    <ul>
      <li>
        <a href="#11-описание-предметной-области-и-функции-решаемых-задач">
          1.1. Описание предметной области и функции решаемых задач
        </a>
      </li>
      <li>
        <a href="#12-перечень-входных-данных">
          1.2. Перечень входных данных
        </a>
      </li>
      <li>
        <a href="#13-перечень-выходных-данных">
          1.3. Перечень выходных данных
        </a>
      </li>
      <li>
        <a href="#14-ограничения-предметной-области-если-таковые-имеются">
          1.4. Ограничения предметной области (если таковые имеются)
        </a>
      </li>
      <li>
        <a href="#15-взаимодействие-с-другими-программами">
          1.5. Взаимодействие с другими программами
        </a>
      </li>
    </ul>
  </li>

  <li>
    <a href="#2-инфологическая-концептуальная-модель-базы-данных">
      2. Инфологическая (концептуальная) модель базы данных
    </a>
    <ul>
      <li>
        <a href="#21-выделение-информационных-объектов">
          2.1. Выделение информационных объектов
        </a>
      </li>
      <li>
        <a href="#22-определение-атрибутов-объектов">
          2.2. Определение атрибутов объектов
        </a>
      </li>
      <li>
        <a href="#23-определение-отношений-и-мощности-отношений-между-объектами">
          2.3. Определение отношений и мощности отношений между объектами
        </a>
      </li>
      <li>
        <a href="#24-построение-концептуальной-модели">
          2.4. Построение концептуальной модели
        </a>
      </li>
    </ul>
  </li>

  <li><a href="#3-логическая-структура-бд">3. Логическая структура БД</a></li>
  <li><a href="#4-физическая-структура-базы-данных">4. Физическая структура базы данных</a></li>

  <li>
    <a href="#5-реализация-проекта-в-среде-конкретной-субд">
      5. Реализация проекта в среде конкретной СУБД
    </a>
    <ul>
      <li><a href="#51-создание-таблиц">5.1. Создание таблиц</a></li>
      <li><a href="#52-создание-запросов">5.2. Создание запросов</a></li>
      <li><a href="#53-разработка-интерфейса">5.3. Разработка интерфейса</a></li>
      <li><a href="#54-назначение-прав-доступа">5.4. Назначение прав доступа</a></li>
      <li><a href="#55-создание-индексов">5.5. Создание индексов</a></li>
      <li>
        <a href="#56-разработка-стратегии-резервного-копирования-базы-данных">
          5.6. Разработка стратегии резервного копирования базы данных
        </a>
      </li>
      <li>
        <a href="#57-разработка-стратегии-защиты-базы-данных-и-хранимой-в-ней-информации">
          5.7. Разработка стратегии защиты базы данных и хранимой в ней информации
        </a>
      </li>
      <li>
        <a href="#58-разработка-api-реализующего-работу-с-базой-данных-стороннего-приложения">
          5.8. Разработка API, реализующего работу с базой данных стороннего приложения
        </a>
      </li>
    </ul>
  </li>

  <li><a href="#заключение">Заключение</a></li>
  <li><a href="#список-использованных-информационных-источников">Список использованных информационных источников</a></li>
  <li><a href="#приложения">Приложения</a></li>
</ul>

---

<h2 id="введение">Введение</h2>

<p>В условиях развития рынка аренды недвижимости, особенно сегмента посуточной и краткосрочной аренды квартир, возрастает потребность в эффективных системах управления бизнес-процессами специализированных агентств. Современное агентство по аренде квартир сталкивается с комплексными задачами: управление большим портфелем объектов недвижимости, обработка бронирований, взаимодействие с клиентами (гостями) и владельцами недвижимости, организация сервисного обслуживания (уборки, ремонт), контроль финансовых потоков и формирование аналитической отчетности.</p>

<p>Ручное управление этими процессами становится неэффективным, ведет к ошибкам, потере данных, снижению качества сервиса и, как следствие, к потере клиентов и доходов. Автоматизация с помощью специализированной информационной системы является ключевым решением для повышения операционной эффективности, обеспечения надежности хранения информации и улучшения клиентского опыта.</p>

<p><strong>Целью данной курсовой работы</strong> является проектирование, реализация и внедрение комплексной реляционной базы данных и веб-приложения для управления всеми бизнес-процессами агентства по аренде квартир (посуточно и длительно) с использованием современных технологий.</p>

<p><strong>Задачи работы:</strong></p>
<ul>
    <li>Провести анализ предметной области агентства аренды квартир и сформулировать требования к информационной системе.</li>
    <li>Разработать инфологическую (ER), логическую и физическую модели базы данных.</li>
    <li>Реализовать базу данных в СУБД PostgreSQL с созданием всех необходимых таблиц, связей, индексов, триггеров и хранимых процедур.</li>
    <li>Разработать веб-интерфейс на PHP с использованием фреймворка Bootstrap для интуитивного управления данными.</li>
    <li>Реализовать систему аутентификации и авторизации с разграничением прав доступа (администратор, сотрудник, клинер, гость).</li>
    <li>Внедрить механизмы защиты данных, аудита действий пользователей и стратегию резервного копирования.</li>
    <li>Заполнить базу данных тестовыми данными для демонстрации функциональности.</li>
    <li>Протестировать работоспособность системы и разработать эксплуатационную документацию.</li>
</ul>

<p><strong>Актуальность темы</strong> обусловлена ростом популярности сервисов краткосрочной аренды жилья, увеличением числа профессиональных агентств на рынке и необходимостью цифровой трансформации их бизнес-процессов для повышения конкурентоспособности.</p>

<div class="page-break"></div>

<h2 id="1-анализ-предметной-области-постановка-задачи">1. Анализ предметной области. Постановка задачи</h2>

<h3 id="11-описание-предметной-области-и-функции-решаемых-задач">1.1. Описание предметной области и функции решаемых задач</h3>

<p><strong>Предметная область</strong> – деятельность профессионального агентства, специализирующегося на посуточной и долгосрочной аренде квартир, апартаментов, студий и другой жилой недвижимости. Агентство выступает посредником между владельцами недвижимости (арендодателями) и клиентами (арендаторами/гостями). Основной доход формируется за счет комиссии от успешных сделок или фиксированной платы за управление объектом.</p>

<p><strong>Основные бизнес-процессы:</strong></p>
<ol>
    <li><strong>Управление портфелем объектов недвижимости:</strong> Ведение каталога (добавление, редактирование, деактивация), загрузка фотогалерей, детальное описание характеристик (площадь, этаж, планировка, удобства), управление динамическим ценообразованием и календарем доступности.</li>
    <li><strong>Взаимодействие с клиентами (гостями):</strong> Регистрация гостей на сайте, ведение профилей (паспортные данные, контакты, история бронирований, рейтинг и отзывы), общение через внутреннюю систему сообщений или чат.</li>
    <li><strong>Обработка бронирований и заявок:</strong> Прием заявок через сайт, телефон или партнерские каналы; подтверждение брони, расчет стоимости с учетом тарифов, сезонности и длительности проживания; формирование счета и договора.</li>
    <li><strong>Управление финансовыми потоками:</strong> Прием оплаты (онлайн-платежи, банковские переводы, наличные), учет депозитов (залогов), обработка возвратов, автоматическое распределение выплат владельцам, формирование финансовой отчетности.</li>
    <li><strong>Организация сервисного обслуживания:</strong> Планирование и контроль уборки после каждого гостя, организация текущего ремонта, заказ дополнительных услуг (трансфер, завтрак в номер, экскурсии).</li>
    <li><strong>Контроль качества и безопасность:</strong> Сбор и модерация отзывов от гостей, ведение черного списка недобросовестных клиентов, регулярная проверка состояния имущества (инвентаризация), контроль за соблюдением правил проживания.</li>
    <li><strong>Управление персоналом и задачами:</strong> Учет сотрудников (менеджеры, риелторы, клинеры, администраторы), назначение задач (показ объекта, встреча гостя, уборка), контроль выполнения, расчет заработной платы.</li>
    <li><strong>Аналитика, отчетность и маркетинг:</strong> Формирование статистики по загрузке объектов, выручке, популярности районов и типов жилья; оценка эффективности сотрудников и рекламных каналов; управление промо-акциями и скидками.</li>
</ol>

<h3 id="12-перечень-входных-данных">1.2. Перечень входных данных</h3>

<ul>
    <li><strong>Данные о владельцах/арендодателях:</strong> ФИО (или название компании), контактные данные (телефон, email, адрес), реквизиты для выплат, особые условия сотрудничества.</li>
    <li><strong>Характеристики объектов аренды:</strong> Юридический и фактический адрес, тип объекта (квартира, апартаменты, студия, лофт), площадь, этаж, количество комнат, описание, фотографии, список удобств (Wi-Fi, кондиционер, парковка и т.д.).</li>
    <li><strong>Тарифные планы и правила ценообразования:</strong> Базовая цена за ночь/месяц, сезонные коэффициенты, скидки за длительное проживание, специальные цены на праздничные даты, минимальный срок аренды.</li>
    <li><strong>Данные о клиентах (гостях):</strong> ФИО, паспортные данные, гражданство, дата рождения, email, телефон, предпочтения.</li>
    <li><strong>Данные о сотрудниках агентства:</strong> ФИО, должность, отдел, контактные данные, данные для расчета зарплаты, права доступа к системе.</li>
    <li><strong>Заявки на бронирование:</strong> Выбранный объект, даты заезда и выезда, количество взрослых и детей, особые пожелания, контактные данные гостя.</li>
    <li><strong>Финансовые операции:</strong> Сумма платежа, валюта, способ оплаты, статус, назначение (аренда, депозит, штраф, возврат), данные платежной системы.</li>
    <li><strong>Задачи на обслуживание:</strong> Тип задачи (уборка, ремонт, встреча гостя), объект, дата и время, ответственный сотрудник, приоритет, описание.</li>
    <li><strong>Отзывы и рейтинги:</strong> Текстовый отзыв, оценки по различным критериям (чистота, расположение, общение с хостом), статус модерации.</li>
    <li><strong>Данные для черного списка:</strong> Идентификаторы гостя (ФИО, телефон, паспорт), причина блокировки, дата инцидента, срок блокировки.</li>
    <li><strong>Системные настройки и конфигурация:</strong> Время заезда/выезда по умолчанию, процент комиссии агентства, настройки уведомлений (email, SMS), параметры сайта.</li>
</ul>

<h3 id="13-перечень-выходных-данных">1.3. Перечень выходных данных</h3>

<ul>
    <li><strong>Публичный каталог объектов:</strong> Страницы с описанием объектов, фотогалереей, календарем доступности и ценами для поиска и бронирования на сайте агентства.</li>
    <li><strong>Подтверждение бронирования (ваучер):</strong> Документ с деталями брони для гостя: адрес объекта, даты, правила заезда, контакты поддержки.</li>
    <li><strong>Счета, квитанции и финансовые документы:</strong> Счета на оплату, квитанции об оплате, акты выполненных работ для владельцев.</li>
    <li><strong>Отчеты для руководства и владельцев:</strong>
        <ul>
            <li>Финансовый отчет (выручка, расходы, прибыль, ожидаемые платежи) за период.</li>
            <li>Отчет по загрузке и доходности объектов (процент занятости, средний доход за ночь, RevPAR).</li>
            <li>Отчет по эффективности сотрудников (количество закрытых сделок, выручка, выполнение задач).</li>
            <li>Отчет по отзывам и рейтингам (средний рейтинг по объектам и агентству в целом).</li>
            <li>Отчет по маркетингу (источники бронирований, конверсия).</li>
        </ul>
    </li>
    <li><strong>Календарь занятости (Timeline):</strong> Визуальное представление занятости каждого объекта на день, неделю, месяц.</li>
    <li><strong>График задач для сотрудников:</strong> Ежедневный/еженедельный план для менеджеров, клинеров с указанием времени и места.</li>
    <li><strong>Панель управления (Dashboard):</strong> Ведб-интерфейс с ключевыми метриками (KPI) в реальном времени: сегодняшние заезды/выезды, текущая выручка, незавершенные задачи.</li>
    <li><strong>Автоматические уведомления:</strong> Email и SMS уведомления для гостей (подтверждение брони, напоминание о заезде, просьба оставить отзыв) и сотрудников (новая заявка, задача, просроченный платеж).</li>
    <li><strong>API-ответы:</strong> Данные в формате JSON/XML для интеграции с внешними системами: каналы продаж (Airbnb, Booking.com), бухгалтерские программы (1С), CRM-системы.</li>
</ul>

<h3 id="14-ограничения-предметной-области-если-таковые-имеются">1.4. Ограничения предметной области (если таковые имеются)</h3>

<ol>
    <li><strong>Хронологическая целостность:</strong> Бронирование не может быть создано на прошедшие даты. Дата и время заезда должны быть позже текущего момента (с учетом времени на подготовку).</li>
    <li><strong>Логическая целостность дат:</strong> Дата выезда должна быть строго позже даты заезда. Минимальный срок аренды может быть ограничен (например, 1 ночь для посуточной, 30 дней для долгосрочной).</li>
    <li><strong>Ограничение по вместимости:</strong> Количество гостей (взрослых и детей), указанное в бронировании, не может превышать максимальную вместимость, установленную для объекта.</li>
    <li><strong>Финансовые ограничения:</strong> Цена аренды, плата за уборку, депозит не могут быть отрицательными. Сумма оплаты не может превышать общую сумму бронирования.</li>
    <li><strong>Уникальность бронирования (контроль коллизий):</strong> Один объект недвижимости не может быть забронирован двумя разными гостями на пересекающиеся даты. Система должна проверять доступность перед подтверждением новой брони.</li>
    <li><strong>Ограничения доступа:</strong> Гость, внесенный в черный список, не может создать новое бронирование. Попытка бронирования от такого гостя должна блокироваться с уведомлением менеджера.</li>
    <li><strong>Бизнес-правила для услуг:</strong> Некоторые услуги (например, глубокая уборка) требуют предварительного бронирования и не могут быть оказаны в день заезда. Количество доступных услуг в день может быть ограничено.</li>
    <li><strong>Правила применения скидок и промокодов:</strong> Промокод может иметь ограничение по количеству использований, сроку действия, минимальной сумме заказа или применяться только к определенным объектам или тарифам.</li>
    <li><strong>Правила отмены бронирования:</strong> Возврат средств регулируется политикой отмены, которая зависит от времени до заезда. Например, бесплатная отмена за 48 часов, 50% возврат за 24 часа, отсутствие возврата позднее.</li>
</ol>

<h3 id="15-взаимодействие-с-другими-программами">1.5. Взаимодействие с другими программами</h3>

<ol>
    <li><strong>Платежные шлюзы и эквайринг (ЮKassa, Тинькофф, Сбербанк):</strong> Обмен данными через API для приема онлайн-платежей за бронирования. Получение статуса платежа, инициация возвратов.</li>
    <li><strong>Серверы электронной почты (SMTP):</strong> Рассылка автоматических и массовых уведомлений, подтверждений, напоминаний гостям, владельцам и сотрудникам. Использование почтовых сервисов или собственного SMTP.</li>
    <li><strong>Сервисы онлайн-карт (Google Maps API, Yandex Maps API, 2GIS):</strong> Отображение объектов на интерактивной карте на сайте, расчет расстояний до достопримечательностей, метро, аэропорта. Геокодирование адресов.</li>
    <li><strong>Облачные хранилища и CDN (Amazon S3, Яндекс.Облако, Selectel):</strong> Хостинг фотографий объектов, сканов документов (паспортов, договоров). Обеспечение быстрой загрузки и резервного копирования медиафайлов.</li>
    <li><strong>Внешние каналы продаж и календарные синхронизации (Airbnb API, Booking.com API, Ostrovok.ru):</strong> Двусторонняя синхронизация календаря доступности и цен для управления бронированиями из единого интерфейса. Получение заявок и отправка подтверждений.</li>
    <li><strong>Мессенджеры и SMS-шлюзы (Telegram Bot API, WhatsApp Business API, SMS.ru):</strong> Отправка уведомлений и общение с гостями через популярные мессенджеры. SMS-напоминания о заезде.</li>
    <li><strong>CRM-системы (Битрикс24, amoCRM, Megaplan):</strong> Экспорт данных о клиентах, сделках (бронированиях) и задачах для дальнейшей работы отдела продаж и маркетинга, построения воронки.</li>
    <li><strong>Бухгалтерские системы (1С, «Парус»):</strong> Экспорт финансовых данных (платежи, расходы, выплаты владельцам) для ведения бухгалтерского и налогового учета.</li>
    <li><strong>Сервисы аналитики (Google Analytics, Яндекс.Метрика, Mixpanel):</strong> Интеграция для отслеживания поведения пользователей на сайте, конверсии бронирований, эффективности рекламных кампаний.</li>
</ol>

<div class="page-break"></div>

<h2 id="2-инфологическая-концептуальная-модель-базы-данных">2. Инфологическая (концептуальная) модель базы данных</h2>

<h3 id="21-выделение-информационных-объектов">2.1. Выделение информационных объектов</h3>

<p>В результате анализа предметной области были выделены следующие ключевые <strong>сущности (информационные объекты)</strong> системы:</p>

<ol>
    <li><strong>User (Пользователь):</strong> Учетная запись для входа в систему. Базовый класс, от которого наследуются профили гостя, сотрудника, администратора. Содержит данные для аутентификации (email, хеш пароля) и базовую роль.</li>
    <li><strong>Guest (Гость/Клиент):</strong> Физическое лицо, снимающее жилье. Основной клиент агентства. Содержит персональные и контактные данные, историю бронирований, рейтинг.</li>
    <li><strong>Employee (Сотрудник):</strong> Работник агентства (риелтор, менеджер по аренде, клинер, администратор, бухгалтер). Содержит кадровые данные, должность, отдел, данные для расчета зарплаты.</li>
    <li><strong>Property (Объект недвижимости):</strong> Квартира, апартаменты, студия, лофт и т.д., сдаваемая в аренду. Центральная сущность каталога.</li>
    <li><strong>PropertyType (Тип объекта):</strong> Справочник типов недвижимости (квартира, апартаменты, студия, луфт, пентхаус). Используется для классификации и фильтрации.</li>
    <li><strong>PropertyCategory (Категория объекта):</strong> Справочник категорий (посуточная аренда, долгосрочная аренда, премиум, эконом, для бизнеса). Определяет бизнес-логику и правила отображения.</li>
    <li><strong>RentalPlan (Тарифный план):</strong> Правила расчета стоимости аренды (посуточно, помесячно, скидки за длительное проживание). Связан с объектом или категорией.</li>
    <li><strong>Booking (Бронирование):</strong> Центральная сущность системы, фиксирующая факт аренды объекта конкретным гостем на определенный период. Является регистрируемым событием, порождающим финансовые операции и задачи.</li>
    <li><strong>Payment (Платеж):</strong> Финансовая операция, связанная с бронированием (оплата аренды, депозит, возврат, штраф). Может быть несколько платежей на одно бронирование.</li>
    <li><strong>CleaningTask (Задача на уборку):</strong> Работа по обслуживанию объекта, привязанная к конкретному бронированию (уборка после выезда) или плановая. Содержит статус, время, ответственного клинера.</li>
    <li><strong>Service (Дополнительная услуга):</strong> Услуга, которую можно заказать отдельно от проживания (трансфер из аэропорта, завтрак в номер, аренда детской кроватки).</li>
    <li><strong>BookingService (Заказ услуги):</strong> Связь бронирования с выбранной дополнительной услугой. Разрешает связь многие-ко-многим между Booking и Service.</li>
    <li><strong>Review (Отзыв):</strong> Оценка и текстовый комментарий гостя о его проживании. Привязан к конкретному завершенному бронированию.</li>
    <li><strong>Blacklist (Черный список):</strong> Запись о недобросовестных клиентах или подозрительных лицах. Содержит причину и идентификаторы для автоматической проверки новых бронирований.</li>
    <li><strong>AuditLog (Журнал аудита):</strong> История значимых действий пользователей в системе (вход, создание брони, изменение цены). Необходим для безопасности и отладки.</li>
    <li><strong>Notification (Уведомление):</strong> Сообщение для пользователя внутри системы или отправленное по email/SMS. Может быть связано с бронированием, платежом, задачей.</li>
    <li><strong>Message (Сообщение чата):</strong> Переписка между пользователями системы (например, гость и менеджер). Может быть привязана к бронированию.</li>
    <li><strong>SiteSetting (Настройки сайта):</strong> Конфигурационные параметры системы (название сайта, время заезда, валюта, настройки email), хранимые в базе данных для удобства управления.</li>
    <li><strong>PromoCode (Промокод):</strong> Скидка или специальное предложение с определенными правилами применения (код, срок действия, лимит использований).</li>
    <li><strong>InventoryItem (Предмет инвентаря):</strong> Оборудование и мебель, находящаяся в объекте (холодильник, телевизор, диван). Для контроля сохранности имущества.</li>
    <li><strong>InventoryCheck (Проверка инвентаря):</strong> Акт осмотра имущества при заезде или выезде гостя. Фиксирует состояние предметов и выявленные повреждения.</li>
</ol>

<h3 id="22-определение-атрибутов-объектов">2.2. Определение атрибутов объектов</h3>

<table>
    <tr><th>Сущность</th><th>Ключевые атрибуты (поля)</th></tr>
    <tr><td><strong>User</strong></td><td><code>user_id</code> (PK), <code>email</code> (уник.), <code>password_hash</code>, <code>role</code> (admin/employee/guest/cleaner), <code>is_active</code>, <code>phone</code>, <code>last_login</code>, <code>created_at</code></td></tr>
    <tr><td><strong>Guest</strong></td><td><code>guest_id</code> (PK), <code>user_id</code> (FK → User), <code>first_name</code>, <code>last_name</code>, <code>passport_number</code>, <code>date_of_birth</code>, <code>rating</code> (средн.), <code>total_bookings</code> (счетчик), <code>verified</code> (булев)</td></tr>
    <tr><td><strong>Employee</strong></td><td><code>employee_id</code> (PK), <code>user_id</code> (FK → User), <code>first_name</code>, <code>last_name</code>, <code>position</code> (должность), <code>department</code> (отдел), <code>hire_date</code>, <code>salary</code></td></tr>
    <tr><td><strong>Property</strong></td><td><code>property_id</code> (PK), <code>title</code> (назв.), <code>address</code>, <code>city</code>, <code>area_sq_m</code> (площадь), <code>rooms</code>, <code>max_guests</code>, <code>description</code>, <code>is_active</code>, <code>rating</code> (средн.), <code>property_type_id</code> (FK), <code>category_id</code> (FK)</td></tr>
    <tr><td><strong>Booking</strong></td><td><code>booking_id</code> (PK), <code>booking_number</code> (уник. номер), <code>property_id</code> (FK), <code>guest_id</code> (FK), <code>check_in_date</code>, <code>check_out_date</code>, <code>adults</code>, <code>children</code>, <code>status</code> (pending/confirmed/active/completed/cancelled), <code>total_price</code>, <code>created_at</code></td></tr>
    <tr><td><strong>Payment</strong></td><td><code>payment_id</code> (PK), <code>booking_id</code> (FK), <code>amount</code>, <code>currency</code>, <code>payment_method</code> (card/cash/transfer), <code>payment_status</code> (pending/completed/failed/refunded), <code>purpose</code> (booking/deposit/refund), <code>transaction_id</code> (из платежки)</td></tr>
    <tr><td><strong>CleaningTask</strong></td><td><code>task_id</code> (PK), <code>booking_id</code> (FK), <code>property_id</code> (FK), <code>cleaner_id</code> (FK → Employee), <code>task_type</code> (checkout/weekly/deep), <code>scheduled_date</code>, <code>status</code> (scheduled/in_progress/completed), <code>cleaning_cost</code></td></tr>
    <tr><td><strong>Review</strong></td><td><code>review_id</code> (PK), <code>booking_id</code> (FK, уник.), <code>guest_id</code> (FK), <code>property_id</code> (FK), <code>cleanliness_rating</code> (1-5), <code>location_rating</code>, <code>overall_rating</code>, <code>comment</code>, <code>is_approved</code> (модерация)</td></tr>
</table>

<h3 id="23-определение-отношений-и-мощности-отношений-между-объектами">2.3. Определение отношений и мощности отношений между объектами</h3>

<ol>
    <li><strong>User (1) — (1) Guest / Employee:</strong> Один пользователь системы может быть либо гостем, либо сотрудником (или теоретически тем и другим, но в данной системе реализована связь 1:1 через <code>user_id</code>). Это пример <strong>декомпозиции на подтипы</strong> (subtyping). Мощность: <strong>1:1</strong>.</li>
    <li><strong>Property (1) — (М) Booking:</strong> Один объект недвижимости может участвовать во многих бронированиях (в разное время), но одно конкретное бронирование относится ровно к одному объекту. Мощность: <strong>1:М</strong>.</li>
    <li><strong>Guest (1) — (М) Booking:</strong> Один гость может совершить много бронирований (в разных объектах и в разное время). Мощность: <strong>1:М</strong>.</li>
    <li><strong>Booking (1) — (М) Payment:</strong> Одно бронирование может быть оплачено несколькими платежами (например, депозит при бронировании + окончательный расчет перед заездом). Мощность: <strong>1:М</strong>.</li>
    <li><strong>Booking (1) — (1) CleaningTask (на выезд):</strong> На одно завершенное бронирование (статус 'completed') создается ровно одна задача на уборку типа 'checkout'. Для долгосрочной аренды могут быть периодические уборки. Уточненная мощность: <strong>1:М</strong> (бронирование → задачи).</li>
    <li><strong>Booking (М) — (М) Service:</strong> Бронирование может включать в себя несколько дополнительных услуг, и одна и та же услуга (например, трансфер) может быть заказана в разных бронированиях. Связь <strong>"многие-ко-многим"</strong> разрешается через таблицу-ассоциацию <code>BookingService</code>. Мощность: <strong>М:М</strong>.</li>
    <li><strong>Property (М) — (1) PropertyType / PropertyCategory:</strong> Объект принадлежит к одному типу (например, "квартира") и одной категории (например, "посуточная аренда"). Эти связи являются классификационными. Мощность: <strong>М:1</strong>.</li>
    <li><strong>Booking (1) — (0..1) Review:</strong> На одно завершенное бронирование гость может оставить не более одного отзыва (0 или 1). Это связь с ограничением уникальности. Мощность: <strong>1:0..1</strong>.</li>
    <li><strong>Employee (1) — (М) CleaningTask / Booking (managed_by):</strong> Один сотрудник (клинер) может выполнить много задач по уборке. Один сотрудник (менеджер) может курировать много бронирований. Мощность: <strong>1:М</strong>.</li>
    <li><strong>Property (1) — (М) InventoryItem:</strong> В одном объекте находится много предметов инвентаря. Мощность: <strong>1:М</strong>.</li>
    <li><strong>Booking (1) — (М) InventoryCheck:</strong> По одному бронированию может проводиться несколько проверок инвентаря (при заезде и при выезде). Мощность: <strong>1:М</strong>.</li>
</ol>

<h3 id="24-построение-концептуальной-модели">2.4. Построение концептуальной модели</h3>

<p>Ниже представлена текстовая версия ER-диаграммы (нотация Чена), отображающая ключевые сущности и связи между ними. Полная графическая диаграмма прилагается отдельно.</p>

<pre>
    +-------------+       +-------------+       +---------------+
    |    User     |       |   Property  |       |  PropertyType |
    +-------------+       +-------------+       +---------------+
    | user_id(PK) |       | property_id |1-----М|  type_id(PK)  |
    | email       |       | title       |       |  type_name    |
    | role        |       | address     |       +---------------+
    +-----+-------+       | ...         |
          |1              +-------------+
          |                      |1
          |                      |
          |                      М
          |                      |
          |              +-------------+
          |              |   Booking   |
          |              +-------------+
          |              | booking_id  |
          |              | check_in    |
          |              | check_out   |
          |              | status      |
          |              +------+------+
          |                     |1
          |                     |
          |                     М
    +-----+-------+       +------+------+
    |   Guest     |1-----М|   Payment   |
    +-------------+       +-------------+
    | guest_id(PK)|       | payment_id  |
    | first_name  |       | amount      |
    | last_name   |       | status      |
    +-------------+       +-------------+

    +-------------+       +-------------+
    |  Employee   |       |   Service   |
    +-------------+       +-------------+
    | employee_id |       | service_id  |
    | position    |       | name        |
    | department  |       | price       |
    +------+------+       +------+------+
           |1                    |
           |                     М
           М                     |
    +-------------+       +-------------+
    |CleaningTask |       |BookingService|
    +-------------+       +-------------+
    | task_id     |       | booking_id  |
    | task_type   |       | service_id  |
    | status      |       | quantity    |
    +-------------+       +-------------+
</pre>

<p><strong>Пояснение к модели:</strong> Диаграмма показывает ядро системы. <strong>Пользователи</strong> (Гости и Сотрудники) взаимодействуют через центральное событие — <strong>Бронирование</strong> — с <strong>Объектами недвижимости</strong>. Бронирование является регистрируемым событием, которое порождает финансовые операции (<strong>Платежи</strong>), сервисные задачи (<strong>Уборка</strong>) и оценку качества (<strong>Отзывы</strong>). Справочники (<strong>Типы, Категории, Тарифы, Услуги</strong>) обеспечивают гибкость настройки бизнес-логики. Сущности <strong>Журнал аудита</strong>, <strong>Черный список</strong> и <strong>Проверка инвентаря</strong> реализуют дополнительные контрольные и защитные функции системы.</p>

<div class="page-break"></div>

<h2 id="3-логическая-структура-бд">3. Логическая структура БД</h2>

<p>Логическая модель представляет собой схему реляционной базы данных, полученную в результате преобразования ER-модели. Все сущности становятся таблицами, атрибуты – колонками, а связи реализуются через внешние ключи (FOREIGN KEY).</p>

<p><strong>Принципы нормализации:</strong> При проектировании была применена, в основном, <strong>третья нормальная форма (3NF)</strong>:</p>
<ol>
    <li><strong>1NF (Первая нормальная форма):</strong> Все значения атомарны (неделимы), строки уникальны, порядок строк и столбцов не важен. (Соблюдено для всех таблиц).</li>
    <li><strong>2NF (Вторая нормальная форма):</strong> Таблицы находятся в 1NF, и каждый неключевой атрибут полностью зависит от первичного ключа (не от его части). Так как в большинстве таблиц первичный ключ простой (один столбец), 2NF соблюдена автоматически.</li>
    <li><strong>3NF (Третья нормальная форма):</strong> Таблицы находятся в 2NF, и ни один неключевой атрибут не зависит транзитивно от первичного ключа (т.е. не зависит от другого неключевого атрибута). (Соблюдено. Например, в таблице <code>property</code> поля <code>city</code> и <code>district</code> зависят напрямую от <code>property_id</code>, а не друг от друга).</li>
</ol>

<p><strong>Сознательная денормализация</strong> была применена в нескольких случаях для повышения производительности критически важных запросов, где частота чтения данных значительно превышает частоту их изменения:</p>
<ol>
    <li><strong>Таблица <code>property</code>:</strong> Содержит поля <code>rating</code> (средний рейтинг) и <code>views_count</code> (количество просмотров). Эти данные могут (и должны) быть вычислены агрегацией из таблиц <code>review</code> и логов просмотров. Однако их хранение "на месте" избавляет от дорогостоящих операций JOIN и GROUP BY при отображении каталога на сайте, что критично для скорости загрузки страницы.</li>
    <li><strong>Таблица <code>guest</code>:</strong> Содержит поле <code>total_bookings</code>. Количество бронирований гостя может быть подсчитано из таблицы <code>booking</code> по <code>guest_id</code>. Предрасчет этого значения упрощает и ускоряет формирование отчетов и отображение информации в профиле гостя.</li>
    <li><strong>Таблица <code>booking</code>:</strong> Содержит поле <code>total_price</code>. Итоговая сумма может быть рассчитана на основе цен за ночь из <code>price_calendar</code> и данных о дополнительных услугах. Хранение рассчитанной суммы исключает необходимость ее пересчета каждый раз при отображении бронирования и повышает точность финансовой отчетности (цена "замораживается" на момент создания брони).</li>
</ol>

<p>Данные денормализованные поля должны обновляться с помощью триггеров или фоновых задач (cron), чтобы обеспечить их актуальность.</p>

<div class="page-break"></div>

<h2 id="4-физическая-структура-базы-данных">4. Физическая структура базы данных</h2>

<h3>4.1. Выбор СУБД и обоснование</h3>
<p>Выбрана СУБД <strong>PostgreSQL 14+</strong> по следующим причинам:</p>
<ul>
    <li><strong>Надежность и стабильность:</strong> Соответствует ACID, гарантирует целостность данных даже в условиях сбоев.</li>
    <li><strong>Производительность:</strong> Эффективный планировщик запросов, поддержка сложных индексов (GIN, GiST), кэширование.</li>
    <li><strong>Расширенные возможности:</strong> Поддержка JSON/JSONB для хранения полуструктурированных данных (например, метаданные платежей, использованные материалы при уборке), полнотекстовый поиск, пространственные данные (PostGIS, если понадобится для карт).</li>
    <li><strong>Масштабируемость:</strong> Возможность репликации, партиционирования таблиц (например, партиционирование <code>booking</code> по дате).</li>
    <li><strong>Лицензия:</strong> Open-source (лицензия PostgreSQL), что исключает затраты на лицензирование.</li>
    <li><strong>Сообщество и документация:</strong> Огромное сообщество, богатая документация, обилие готовых решений и расширений.</li>
</ul>

<h3>4.2. Типы данных, выбранные для атрибутов</h3>
<table>
    <tr><th>Тип данных PostgreSQL</th><th>Применение</th><th>Пример поля</th></tr>
    <tr><td><code>SERIAL</code> / <code>BIGSERIAL</code></td><td>Автоинкрементные первичные ключи.</td><td><code>user_id SERIAL PRIMARY KEY</code></td></tr>
    <tr><td><code>INTEGER</code> / <code>BIGINT</code></td><td>Целочисленные данные: количество, этаж, год, внешние ключи.</td><td><code>max_guests INTEGER</code>, <code>floor INTEGER</code></td></tr>
    <tr><td><code>NUMERIC(p,s)</code> / <code>DECIMAL(p,s)</code></td><td>Точные числовые значения для финансовых операций. <code>p</code> - точность, <code>s</code> - масштаб.</td><td><code>price DECIMAL(10,2)</code> (10 цифр, 2 после запятой)</td></tr>
    <tr><td><code>VARCHAR(n)</code> / <code>TEXT</code></td><td>Текстовые данные. <code>VARCHAR</code> - для строк с известным макс. размером (email, телефон), <code>TEXT</code> - для неограниченного текста (описание, комментарий).</td><td><code>email VARCHAR(255)</code>, <code>description TEXT</code></td></tr>
    <tr><td><code>BOOLEAN</code></td><td>Логические значения (истина/ложь).</td><td><code>is_active BOOLEAN DEFAULT TRUE</code></td></tr>
    <tr><td><code>DATE</code></td><td>Дата без времени.</td><td><code>check_in_date DATE</code></td></tr>
    <tr><td><code>TIMESTAMP</code> / <code>TIMESTAMPTZ</code></td><td>Дата и время. <code>TIMESTAMPTZ</code> (timestamp with time zone) рекомендуется для хранения моментов времени с учетом часового пояса.</td><td><code>created_at TIMESTAMPTZ DEFAULT NOW()</code></td></tr>
    <tr><td><code>JSONB</code></td><td>Двоичное представление JSON. Позволяет хранить структурированные данные, индексировать и запрашивать их. Эффективнее <code>JSON</code>.</td><td><code>metadata JSONB DEFAULT '{}'</code> (для доп. данных платежа)</td></tr>
    <tr><td><code>ARRAY</code></td><td>Массивы значений одного типа.</td><td><code>photos TEXT[]</code> (массив ссылок на фото)</td></tr>
    <tr><td><code>UUID</code></td><td>Уникальные идентификаторы (альтернатива SERIAL).</td><td><code>session_id UUID PRIMARY KEY</code></td></tr>
</table>

<h3>4.3. Стратегия резервного копирования</h3>
<p>Для обеспечения отказоустойчивости и возможности восстановления данных после сбоя разработана многоуровневая стратегия:</p>
<ol>
    <li><strong>Ежедневные полные резервные копии (Full Backup):</strong> Выполняются ежедневно в 02:00 ночи (время минимальной нагрузки) с помощью утилиты <code>pg_dump</code> в custom-формате (сжатие, параллельность). Хранятся 7 последних копий на выделенном сервере.</li>
    <li><strong>Непрерывное архивирование WAL (Write-Ahead Logging):</strong> Включен режим архивации WAL-файлов. Это позволяет восстановить базу данных на любой момент времени вплоть до последней зафиксированной транзакции (Point-in-Time Recovery, PITR). WAL-файлы архивируются в облачное хранилище (например, Yandex Object Storage).</li>
    <li><strong>Репликация:</strong> Настроена streaming-репликация на standby-сервер (горячий резерв). В случае падения основного сервера, реплика может быть быстро переведена в режим primary.</li>
    <li><strong>Проверка восстановления:</strong> Раз в месяц проводится процедура тестового восстановления из резервной копии на тестовом стенде для проверки ее целостности и отработки действий администратора.</li>
</ol>

<pre><code class="language-bash">#!/bin/bash
# Пример скрипта для ежедневного бэкапа (backup.sh)
BACKUP_DIR="/var/backups/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="rental_agency"

# Полное резервное копирование в custom формате
pg_dump -h localhost -U postgres -F c -b -v -f "$BACKUP_DIR/full_$DATE.backup" $DB_NAME

# Архивируем WAL файлы (требует настройки archive_command в postgresql.conf)
# Удаляем старые резервные копии (храним 7 дней)
find $BACKUP_DIR -name "*.backup" -mtime +7 -delete

# Проверка целостности бэкапа (список содержимого)
pg_restore -l "$BACKUP_DIR/full_$DATE.backup" > /dev/null && echo "Backup $DATE OK" || echo "Backup $DATE FAILED"</code></pre>

<h3>4.4. Безопасность данных на уровне СУБД</h3>
<ol>
    <li><strong>Шифрование паролей:</strong> Пароли пользователей никогда не хранятся в открытом виде. Используется алгоритм хеширования <code>bcrypt</code> с солью (salt) через функцию <code>password_hash()</code> в PHP. В самой БД хранится только хеш.</li>
    <li><strong>Ролевая модель доступа (Role-Based Access Control, RBAC):</strong> Созданы роли и соответствующие им права доступа только к необходимым таблицам и операциям.
        <ul>
            <li><code>rental_admin</code>: Полный доступ (CREATE, SELECT, INSERT, UPDATE, DELETE) ко всем таблицам.</li>
            <li><code>rental_manager</code>: Доступ на чтение/запись к таблицам <code>property</code>, <code>booking</code>, <code>guest</code>, <code>payment</code>, <code>cleaning_task</code>. Только SELECT к таблицам пользователей и аудита.</li>
            <li><code>rental_cleaner</code>: Доступ только к таблице <code>cleaning_task</code> (обновление статуса, добавление заметок). SELECT к <code>property</code> для адреса.</li>
            <li><code>rental_guest</code>: Очень ограниченный доступ через API или веб-формы. Может только INSERT в <code>booking</code> (создание заявки), SELECT своих данных в <code>guest</code> и <code>booking</code>.</li>
        </ul>
    </li>
    <li><strong>SSL-шифрование подключений:</strong> Все подключения к серверу PostgreSQL требуют использования SSL/TLS для шифрования трафика между приложением и СУБД.</li>
    <li><strong>Ограничение доступа по IP-адресам (pg_hba.conf):</strong> В файле <code>pg_hba.conf</code> разрешены подключения только с доверенных IP-адресов серверов приложения.</li>
    <li><strong>Маскирование данных (Data Masking):</strong> Для тестовых сред и разработки используются маскированные копии базы, где конфиденциальные данные (паспортные номера, телефоны, email) заменяются на вымышленные.</li>
</ol>

<div class="page-break"></div>

<h2 id="5-реализация-проекта-в-среде-конкретной-субд">5. Реализация проекта в среде PostgreSQL</h2>

<h3 id="51-создание-таблиц">5.1. Создание таблиц</h3>
<p>Приведен SQL код создания основных таблиц базы данных. Полный скрипт включает все таблицы, индексы, триггеры и заполнение тестовыми данными.</p>

<h4>5.1.1. Таблица пользователей (users) - основа системы аутентификации</h4>
<pre><code class="language-sql">-- Таблица пользователей для авторизации на сайте
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,                 -- Уникальный ID пользователя
    email VARCHAR(255) UNIQUE NOT NULL,        -- Email (логин)
    password_hash VARCHAR(255) NOT NULL,        -- Хеш пароля (bcrypt)
    role VARCHAR(50) NOT NULL DEFAULT 'guest', -- Роль: guest, employee, admin, cleaner
    is_active BOOLEAN DEFAULT TRUE,            -- Активен ли аккаунт
    email_verified BOOLEAN DEFAULT FALSE,      -- Подтвержден ли email
    phone VARCHAR(50),                          -- Телефон для связи
    avatar_url TEXT,                            -- Ссылка на аватар
    last_login TIMESTAMP WITH TIME ZONE,        -- Дата последнего входа
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Индексы для быстрого поиска
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_last_login ON users(last_login);

-- Триггер для автоматического обновления updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE
    ON users FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();</code></pre>

<h4>5.1.2. Таблица гостей (guest)</h4>
<pre><code class="language-sql">CREATE TABLE guest (
    guest_id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE REFERENCES users(user_id) ON DELETE SET NULL,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE,
    phone VARCHAR(50) UNIQUE NOT NULL,
    passport_number VARCHAR(100),              -- Номер паспорта
    passport_issue_date DATE,                  -- Дата выдачи
    passport_issued_by TEXT,                   -- Кем выдан
    date_of_birth DATE,                        -- Дата рождения
    preferred_language VARCHAR(10) DEFAULT 'ru', -- Язык предпочтений
    marketing_consent BOOLEAN DEFAULT FALSE,   -- Согласие на рассылку
    verified BOOLEAN DEFAULT FALSE,            -- Верифицирован
    rating DECIMAL(3,2) DEFAULT 5.0,           -- Рейтинг
    total_bookings INTEGER DEFAULT 0,          -- Всего бронирований
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Триггер для обновления updated_at
CREATE TRIGGER update_guest_updated_at BEFORE UPDATE
    ON guest FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();</code></pre>

<h4>5.1.3. Таблица объектов недвижимости (property)</h4>
<pre><code class="language-sql">CREATE TABLE property (
    property_id SERIAL PRIMARY KEY,
    owner_name VARCHAR(255) NOT NULL,         -- Владелец (физическое лицо или компания)
    property_type_id INTEGER REFERENCES property_type(type_id),
    category_id INTEGER REFERENCES property_category(category_id),
    title VARCHAR(255) NOT NULL,              -- Заголовок для сайта
    slug VARCHAR(255) UNIQUE NOT NULL,        -- ЧПУ для URL объекта
    address VARCHAR(500) NOT NULL,
    city VARCHAR(100) NOT NULL,
    district VARCHAR(100),                     -- Район
    metro_station VARCHAR(100),                -- Станция метро
    latitude DECIMAL(10,8),                    -- Широта для карты
    longitude DECIMAL(11,8),                   -- Долгота для карты
    floor INTEGER NOT NULL,                    -- Этаж
    floors_in_building INTEGER,                -- Этажей в доме
    area_sq_m DECIMAL(10,2) NOT NULL,         -- Площадь
    rooms INTEGER NOT NULL,                    -- Количество комнат
    max_guests INTEGER NOT NULL,              -- Максимум гостей
    beds INTEGER NOT NULL,                     -- Количество кроватей
    has_wifi BOOLEAN DEFAULT TRUE,            -- Есть Wi-Fi
    has_tv BOOLEAN DEFAULT TRUE,              -- Есть телевизор
    has_kitchen BOOLEAN DEFAULT TRUE,         -- Есть кухня
    has_washer BOOLEAN DEFAULT FALSE,         -- Есть стиральная машина
    has_ac BOOLEAN DEFAULT FALSE,             -- Есть кондиционер
    has_parking BOOLEAN DEFAULT FALSE,        -- Есть парковка
    pets_allowed BOOLEAN DEFAULT FALSE,       -- Разрешены животные
    smoking_allowed BOOLEAN DEFAULT FALSE,    -- Разрешено курение
    description TEXT NOT NULL,                 -- Полное описание
    short_description VARCHAR(500),           -- Краткое описание для карточки
    check_in_time TIME DEFAULT '14:00',       -- Время заезда
    check_out_time TIME DEFAULT '12:00',      -- Время выезда
    is_active BOOLEAN DEFAULT TRUE,           -- Активен для бронирования
    featured BOOLEAN DEFAULT FALSE,           -- Выделенный объект на главной
    views_count INTEGER DEFAULT 0,            -- Количество просмотров
    rating DECIMAL(3,2) DEFAULT 0,            -- Средний рейтинг
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    managed_by_employee_id INTEGER REFERENCES employee(employee_id) -- Ответственный менеджер
);

-- Триггер для updated_at
CREATE TRIGGER update_property_updated_at BEFORE UPDATE
    ON property FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();</code></pre>

<h4>5.1.4. Таблица бронирований (booking) - центральная сущность</h4>
<pre><code class="language-sql">CREATE TABLE booking (
    booking_id SERIAL PRIMARY KEY,
    property_id INTEGER NOT NULL REFERENCES property(property_id),
    guest_id INTEGER NOT NULL REFERENCES guest(guest_id),
    plan_id INTEGER NOT NULL REFERENCES rental_plan(plan_id),
    employee_id INTEGER REFERENCES employee(employee_id),

    -- Основные данные бронирования
    booking_number VARCHAR(20) UNIQUE NOT NULL, -- Уникальный номер для клиента (BKG-2024-001)
    status VARCHAR(30) NOT NULL CHECK (status IN ('pending', 'confirmed', 'paid', 'active', 'completed', 'cancelled', 'refunded')),

    -- Даты проживания
    check_in_date DATE NOT NULL,
    check_out_date DATE NOT NULL,
    nights INTEGER NOT NULL,

    -- Гости
    adults INTEGER NOT NULL DEFAULT 1,
    children INTEGER DEFAULT 0,
    pets INTEGER DEFAULT 0,

    -- Цены и платежи
    base_price DECIMAL(12,2) NOT NULL,      -- Базовая стоимость
    cleaning_fee DECIMAL(8,2) DEFAULT 1000, -- Плата за уборку
    service_fee DECIMAL(8,2) DEFAULT 500,   -- Сервисный сбор
    deposit_amount DECIMAL(10,2) DEFAULT 5000, -- Залог
    total_price DECIMAL(12,2) NOT NULL,     -- Итоговая сумма
    paid_amount DECIMAL(12,2) DEFAULT 0,

    -- Контактная информация на время проживания
    contact_phone VARCHAR(50),
    special_requests TEXT,

    -- Системные поля
    source VARCHAR(50) DEFAULT 'website',   -- Источник брони: website, phone, partner
    cancellation_reason TEXT,
    refund_amount DECIMAL(10,2) DEFAULT 0,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT valid_dates CHECK (check_out_date > check_in_date),
    CONSTRAINT valid_guests CHECK (adults > 0)
);

-- Триггер для генерации номера брони
CREATE OR REPLACE FUNCTION generate_booking_number()
RETURNS TRIGGER AS $$
BEGIN
    NEW.booking_number := 'BKG-' ||
                         EXTRACT(YEAR FROM CURRENT_DATE) || '-' ||
                         LPAD(NEXTVAL('booking_number_seq')::TEXT, 6, '0');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE SEQUENCE booking_number_seq START 100001;
CREATE TRIGGER set_booking_number BEFORE INSERT ON booking
FOR EACH ROW EXECUTE FUNCTION generate_booking_number();

-- Триггер для updated_at
CREATE TRIGGER update_booking_updated_at BEFORE UPDATE ON booking
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();</code></pre>

<h4>5.1.5. Таблица платежей (payment)</h4>
<pre><code class="language-sql">CREATE TABLE payment (
    payment_id SERIAL PRIMARY KEY,
    booking_id INTEGER NOT NULL REFERENCES booking(booking_id),
    user_id INTEGER REFERENCES users(user_id),           -- Кто оплатил
    amount DECIMAL(12,2) NOT NULL,                       -- Сумма платежа
    currency VARCHAR(3) DEFAULT 'RUB',                   -- Валюта
    payment_method VARCHAR(50) NOT NULL,                 -- Способ оплаты: card, cash, transfer, etc.
    payment_gateway VARCHAR(50),                         -- Платежная система: yookassa, tinkoff, etc.
    transaction_id VARCHAR(255) UNIQUE,                  -- ID транзакции в платежной системе
    payment_status VARCHAR(30) NOT NULL CHECK (           -- Статус платежа
        payment_status IN ('pending', 'processing', 'completed', 'failed', 'refunded', 'cancelled')
    ),
    purpose VARCHAR(100) NOT NULL,                       -- Назначение: booking, deposit_refund, penalty, etc.
    description TEXT,                                    -- Описание платежа
    receipt_url TEXT,                                    -- Ссылка на чек
    metadata JSONB DEFAULT '{}',                         -- Дополнительные данные платежной системы

    -- Для возвратов
    refund_reason TEXT,
    refunded_by INTEGER REFERENCES employee(employee_id),

    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Индексы для оптимизации
CREATE INDEX idx_payment_booking ON payment(booking_id);
CREATE INDEX idx_payment_user ON payment(user_id);
CREATE INDEX idx_payment_status ON payment(payment_status);
CREATE INDEX idx_payment_created ON payment(created_at);
CREATE INDEX idx_payment_transaction ON payment(transaction_id);

-- Триггер для updated_at
CREATE TRIGGER update_payment_updated_at BEFORE UPDATE ON payment
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();</code></pre>

<h3 id="52-создание-запросов">5.2. Создание запросов</h3>
<p>Разработаны основные SQL-запросы для выполнения бизнес-логики системы.</p>

<h4>5.2.1. Запрос на проверку доступности объекта на даты (контроль коллизий)</h4>
<pre><code class="language-sql">-- Проверяет, свободен ли объект property_id для бронирования
-- на даты с check_in по check_out (исключая существующие подтвержденные/активные брони)
SELECT NOT EXISTS (
    SELECT 1 FROM booking b
    WHERE b.property_id = $1 -- ID объекта
      AND b.status IN ('confirmed', 'active', 'completed') -- Учитываем только занятые статусы
      AND (
          (b.check_in_date <= $3 AND b.check_out_date >= $2) -- Пересечение периодов
          OR
          (b.check_in_date BETWEEN $2 AND $3) -- Начало существующего брони внутри нового
          OR
          (b.check_out_date BETWEEN $2 AND $3) -- Окончание существующего брони внутри нового
      )
) AS is_available
-- $1 = property_id, $2 = requested_check_in, $3 = requested_check_out</code></pre>

<h4>5.2.2. Запрос для расчета стоимости бронирования</h4>
<pre><code class="language-sql">-- Рассчитывает стоимость проживания на основе цен из календаря и тарифа
WITH night_prices AS (
    SELECT date, price_per_night
    FROM price_calendar
    WHERE property_id = $1
      AND date BETWEEN $2 AND ($3 - INTERVAL '1 day') -- Цены за каждую ночь
      AND is_blocked = FALSE
),
base_cost AS (
    SELECT COALESCE(SUM(price_per_night), 0) AS total_nights_cost
    FROM night_prices
),
plan_details AS (
    SELECT rental_type, monthly_discount_percent
    FROM rental_plan
    WHERE plan_id = $4
)
SELECT
    bc.total_nights_cost AS base_price,
    -- Применяем скидку за долгосрочную аренду, если применимо
    CASE
        WHEN pd.rental_type = 'monthly' AND ($3 - $2) >= 30
        THEN bc.total_nights_cost * (1 - pd.monthly_discount_percent / 100)
        ELSE bc.total_nights_cost
    END AS price_after_discount,
    -- Добавляем фиксированные сборы
    $5 AS cleaning_fee, -- Плата за уборку из настроек объекта
    500 AS service_fee, -- Сервисный сбор агентства
    -- Итоговая сумма
    CASE
        WHEN pd.rental_type = 'monthly' AND ($3 - $2) >= 30
        THEN (bc.total_nights_cost * (1 - pd.monthly_discount_percent / 100)) + $5 + 500
        ELSE bc.total_nights_cost + $5 + 500
    END AS total_price
FROM base_cost bc, plan_details pd;
-- $1 = property_id, $2 = check_in, $3 = check_out, $4 = plan_id, $5 = cleaning_fee</code></pre>

<h4>5.2.3. Запрос для формирования отчета по загрузке объектов за месяц</h4>
<pre><code class="language-sql">-- Отчет показывает процент занятости и доходность каждого объекта
SELECT
    p.property_id,
    p.title,
    p.city,
    COUNT(b.booking_id) AS bookings_count,
    SUM(b.nights) AS total_nights_booked,
    -- Занятость в ночах
    ROUND(
        (SUM(b.nights)::DECIMAL / EXTRACT(DAY FROM DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month' - INTERVAL '1 day')) * 100,
        2
    ) AS occupancy_percent,
    SUM(b.total_price) AS total_revenue,
    -- Средний доход за доступную ночь (RevPAR - Revenue Per Available Room)
    ROUND(
        SUM(b.total_price)::DECIMAL / EXTRACT(DAY FROM DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month' - INTERVAL '1 day'),
        2
    ) AS revpar
FROM property p
LEFT JOIN booking b ON p.property_id = b.property_id
    AND b.status IN ('confirmed', 'active', 'completed')
    AND DATE_TRUNC('month', b.check_in_date) = DATE_TRUNC('month', CURRENT_DATE)
WHERE p.is_active = TRUE
GROUP BY p.property_id, p.title, p.city
ORDER BY total_revenue DESC, occupancy_percent DESC;</code></pre>

<h4>5.2.4. Триггер для автоматического создания задачи на уборку после завершения бронирования</h4>
<pre><code class="language-sql">CREATE OR REPLACE FUNCTION create_cleaning_task_on_checkout()
RETURNS TRIGGER AS $$
BEGIN
    -- Если статус бронирования изменился на 'completed'
    IF NEW.status = 'completed' AND OLD.status != 'completed' THEN
        INSERT INTO cleaning_task (
            booking_id,
            property_id,
            task_type,
            scheduled_date,
            scheduled_time,
            status,
            cleaning_cost
        ) VALUES (
            NEW.booking_id,
            NEW.property_id,
            'checkout',
            NEW.check_out_date,
            '12:00', -- Время по умолчанию
            'scheduled',
            NEW.cleaning_fee
        );
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_create_cleaning_task
AFTER UPDATE OF status ON booking
FOR EACH ROW
EXECUTE FUNCTION create_cleaning_task_on_checkout();</code></pre>

<h4>5.2.5. Представление (View) для отображения календаря занятости объекта</h4>
<pre><code class="language-sql">-- Создает виртуальную таблицу с помесячным календарем занятости
CREATE VIEW property_calendar_view AS
SELECT
    p.property_id,
    p.title,
    gc.date,
    CASE
        WHEN EXISTS (
            SELECT 1 FROM booking b
            WHERE b.property_id = p.property_id
              AND b.status IN ('confirmed', 'active')
              AND gc.date BETWEEN b.check_in_date AND (b.check_out_date - INTERVAL '1 day')
        ) THEN 'booked'
        WHEN EXISTS (
            SELECT 1 FROM price_calendar pc
            WHERE pc.property_id = p.property_id
              AND pc.date = gc.date
              AND pc.is_blocked = TRUE
        ) THEN 'blocked'
        ELSE 'available'
    END AS status,
    COALESCE(pc.price_per_night, pr.base_price) AS price
FROM property p
CROSS JOIN generate_series(
    CURRENT_DATE,
    CURRENT_DATE + INTERVAL '6 months',
    INTERVAL '1 day'
) AS gc(date)
LEFT JOIN price_calendar pc ON p.property_id = pc.property_id AND pc.date = gc.date
LEFT JOIN (
    -- Базовая цена из самого дешевого тарифа для объекта
    SELECT property_id, MIN(base_price_per_night) AS base_price
    FROM rental_plan
    GROUP BY property_id
) pr ON p.property_id = pr.property_id
WHERE p.is_active = TRUE;

-- Использование представления: простой запрос на доступность
-- SELECT * FROM property_calendar_view WHERE property_id = 123 AND date BETWEEN '2024-12-01' AND '2024-12-31';</code></pre>

<h3 id="53-разработка-интерфейса">5.3. Разработка интерфейса</h3>
<p>Веб-интерфейс системы реализован на PHP с использованием фреймворка Bootstrap 5 для адаптивного дизайна. Ниже представлены ключевые компоненты интерфейса.</p>

<h4>5.3.1. Главная страница системы (index.php) - Панель управления</h4>
<p>После успешной авторизации пользователь попадает на главную панель, которая адаптируется под его роль.</p>
<ul>
    <li><strong>Для администратора:</strong> Отображаются все таблицы системы, статистика, SQL-редактор для прямого выполнения запросов, ссылки на управление пользователями и настройками.</li>
    <li><strong>Для менеджера (employee):</strong> Отображаются таблицы бронирований, объектов, гостей, платежей, задач на уборку. Доступны действия по подтверждению бронирований, созданию новых объектов.</li>
    <li><strong>Для клинера (cleaner):</strong> Отображается список задач на уборку с возможностью отметить выполнение, добавить фотоотчет.</li>
    <li><strong>Для гостя (guest):</strong> Просмотр своего профиля, истории бронирований, возможность оставить отзыв.</li>
</ul>
<p>Интерфейс построен по схеме: навигационная панель сверху, меню с таблицами слева, основная рабочая область справа.</p>

<h4>5.3.2. Страница входа (login.php)</h4>
<pre><code class="language-php"><?php
// login.php - Упрощенный пример логики
session_start();
require_once 'config.php';
require_once 'auth.php';

if (isLoggedIn()) {
    header('Location: index.php');
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $email = trim($_POST['email']);
    $password = $_POST['password'];
    $result = loginUser($pdo, $email, $password);
    if ($result['success']) {
        header('Location: index.php?message=login_success');
        exit;
    } else {
        $error = $result['message'];
    }
}
?></code></pre>

<h4>5.3.3. Компонент отображения списка таблиц и данных</h4>
<p>В левой панели главной страницы динамически формируется список всех таблиц БД, сгруппированных по категориям (Основные, Справочники, Операции, Пользователи). При клике на таблицу в правой области загружаются ее данные или структура.</p>

<h4>5.3.4. SQL-редактор (только для администраторов)</h4>
<p>Интегрированный редактор позволяет выполнять SQL-запросы прямо из интерфейса. Для безопасности запросы от не-администраторов проверяются на наличие запрещенных операций (DROP, DELETE, TRUNCATE, ALTER). Результаты запроса отображаются в виде таблицы или сообщения об ошибке.</p>

<h3 id="54-назначение-прав-доступа">5.4. Назначение прав доступа</h3>
<p>Права реализованы на двух уровнях: на уровне базы данных (роли PostgreSQL) и на уровне приложения (проверка роли в PHP-сессии).</p>

<h4>5.4.1. Создание ролей в PostgreSQL</h4>
<pre><code class="language-sql">-- Создание ролей (групп)
CREATE ROLE rental_admin WITH LOGIN PASSWORD 'strong_admin_password';
CREATE ROLE rental_manager WITH LOGIN PASSWORD 'manager_pass';
CREATE ROLE rental_cleaner WITH LOGIN PASSWORD 'cleaner_pass';
CREATE ROLE rental_guest WITH LOGIN PASSWORD 'guest_pass';
-- Примечание: В реальной системе пароли хранятся хэшированно или в защищенных vault.

-- Администратор: полные права
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO rental_admin;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO rental_admin;
GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO rental_admin;

-- Менеджер: права на чтение/запись основных таблиц, чтение справочников
GRANT SELECT, INSERT, UPDATE ON booking, property, guest, payment, cleaning_task, review TO rental_manager;
GRANT SELECT ON users, employee, property_type, property_category, rental_plan TO rental_manager;
GRANT USAGE ON SEQUENCES booking_booking_id_seq, property_property_id_seq TO rental_manager;

-- Клинер: очень ограниченные права
GRANT SELECT ON cleaning_task, property TO rental_cleaner;
GRANT UPDATE (status, completed_at, inspection_notes) ON cleaning_task TO rental_cleaner;

-- Гость (для API): минимальные права
GRANT INSERT ON booking (guest_id, property_id, check_in_date, check_out_date, adults, ...) TO rental_guest;
GRANT SELECT ON property (property_id, title, city, address, ...) TO rental_guest WHERE is_active = TRUE;
GRANT SELECT ON guest (guest_id, first_name, last_name) TO rental_guest; -- Только свои данные через view
</code></pre>

<h4>5.4.2. Проверка прав на уровне приложения (PHP)</h4>
<pre><code class="language-php"><?php
// auth.php - Функции проверки
function hasRole($role) {
    return isset($_SESSION['role']) && $_SESSION['role'] === $role;
}

function requireRole($role) {
    if (!hasRole($role)) {
        header('Location: index.php?message=access_denied');
        exit;
    }
}

// Использование в странице управления пользователями (admin.php)
requireRole('admin');
// ... код страницы, доступной только админу ...
?></code></pre>

<h4>5.4.3. Защита на уровне строк (Row Level Security - RLS) в PostgreSQL</h4>
<p>Для таблиц с конфиденциальными данными (например, <code>guest</code>) можно включить RLS, чтобы гость мог видеть только свою запись, а менеджер — только гостей из своих бронирований.</p>
<pre><code class="language-sql">-- Включаем RLS для таблицы guest
ALTER TABLE guest ENABLE ROW LEVEL SECURITY;

-- Политика для гостей: видят только свою запись
CREATE POLICY guest_self_policy ON guest
    FOR ALL USING (user_id = current_setting('app.current_user_id')::INTEGER);

-- Политика для менеджеров: видят гостей, связанных с их бронированиями
CREATE POLICY manager_guest_policy ON guest
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM booking b
            JOIN employee e ON b.employee_id = e.employee_id
            WHERE b.guest_id = guest.guest_id
            AND e.user_id = current_setting('app.current_user_id')::INTEGER
        )
    );
-- current_setting('app.current_user_id') устанавливается приложением при подключении к БД</code></pre>

<h3 id="55-создание-индексов">5.5. Создание индексов</h3>
<p>Индексы созданы для ускорения наиболее частых и критичных по производительности запросов.</p>

<pre><code class="language-sql">-- Критически важные индексы для быстрой работы сайта и отчетов
-- Для поиска объектов
CREATE INDEX idx_property_city ON property(city);
CREATE INDEX idx_property_active ON property(is_active, featured, rating DESC);
CREATE INDEX idx_property_location ON property USING GIST (ll_to_earth(latitude, longitude)); -- Для поиска по радиусу (требует earthdistance)

-- Для работы с бронированиями (самые частые запросы)
CREATE INDEX idx_booking_dates ON booking(check_in_date, check_out_date, status);
CREATE INDEX idx_booking_guest ON booking(guest_id, status);
CREATE INDEX idx_booking_property_status ON booking(property_id, status) WHERE status IN ('confirmed', 'active');
CREATE INDEX idx_booking_created ON booking(created_at DESC);

-- Для календаря цен и доступности
CREATE INDEX idx_price_calendar_search ON price_calendar(property_id, date, is_blocked);
CREATE INDEX idx_price_calendar_date ON price_calendar(date);

-- Для отзывов и рейтингов
CREATE INDEX idx_review_property ON review(property_id, is_approved, overall_rating DESC);
CREATE INDEX idx_review_created ON review(created_at DESC);

-- Для черного списка (проверка при бронировании)
CREATE INDEX idx_blacklist_search ON blacklist(banned_phone, banned_passport, is_active) WHERE is_active = TRUE;

-- Для полнотекстового поиска по описаниям объектов (опционально)
CREATE INDEX idx_property_fts ON property USING GIN (to_tsvector('russian', title || ' ' || description || ' ' || address));

-- Составные индексы для часто используемых фильтров в админке
CREATE INDEX idx_booking_complex ON booking(property_id, check_in_date, status, total_price);
</code></pre>

<h3 id="56-разработка-стратегии-резервного-копирования-базы-данных">5.6. Разработка стратегии резервного копирования базы данных</h3>
<p>Стратегия резервного копирования, описанная в разделе 4.3, реализована через комбинацию cron-заданий и настройки PostgreSQL.</p>

<h4>5.6.1. Настройка архивации WAL в postgresql.conf</h4>
<pre><code class="language-ini"># В файле postgresql.conf
wal_level = replica                     # Минимум replica для архивации
archive_mode = on                       # Включить архивацию
archive_command = 'test ! -f /var/backups/postgresql/wal_archive/%f && cp %p /var/backups/postgresql/wal_archive/%f'
# Команда копирует WAL-файл в директорию архива. В продакшене нужно копировать в облако.
</code></pre>

<h4>5.6.2. Скрипт для полного бэкапа (backup_full.sh)</h4>
<pre><code class="language-bash">#!/bin/bash
# /usr/local/bin/backup_full.sh
BACKUP_ROOT="/var/backups/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="rental_agency"
BACKUP_FILE="$BACKUP_ROOT/full_$DATE.sql.gz"

<h4>Экспорт с использованием pg_dump, сжатие gzip на лету</h4>
pg_dump -h localhost -U postgres -d $DB_NAME \
  --format=plain \
  --no-owner \
  --no-privileges \
  --verbose 2>&1 | gzip > $BACKUP_FILE

<h4>Проверка успешности создания</h4>
if [ $? -eq 0 ]; then
  echo "[$DATE] Full backup successful: $BACKUP_FILE" >> $BACKUP_ROOT/backup.log
  # Отправка в облако (пример для Yandex Cloud)
  # yc storage cp $BACKUP_FILE s3://my-backup-bucket/postgres/full/
else
  echo "[$DATE] ERROR: Full backup failed!" >> $BACKUP_ROOT/backup.log
  # Отправка уведомления администратору
  echo "Backup failed for $DB_NAME on $(hostname)" | mail -s "BACKUP FAILURE" admin@mail.ru
fi

<h4>Удаление старых локальных бэкапов (храним 7 дней)</h4>
find $BACKUP_ROOT -name "full_*.sql.gz" -mtime +7 -delete
</code></pre>

<h4>5.6.3. Задание в crontab для автоматического выполнения</h4>
<pre><code class="language-crontab"># Ежедневно в 2:30 ночи
30 2 * * * /usr/local/bin/backup_full.sh

<h4>Каждый час - синхронизация WAL-архивов с облаком (упрощенный пример)</h4>
0 * * * * rsync -avz /var/backups/postgresql/wal_archive/ user@backup-server:/backups/wal/

<h4>Еженедельно в воскресенье - проверка целостности последнего бэкапа</h4>
0 5 * * 0 /usr/local/bin/verify_backup.sh
</code></pre>

<h3 id="57-разработка-стратегии-защиты-базы-данных-и-хранимой-в-ней-информации">5.7. Разработка стратегии защиты базы данных и хранимой в ней информации</h3>
<p>Помимо ролевой модели и шифрования паролей, реализованы дополнительные меры защиты.</p>

<ol>
    <li><strong>Шифрование конфиденциальных полей на уровне БД:</strong> Паспортные данные гостей (<code>guest.passport_number</code>) шифруются перед сохранением с использованием симметричного шифрования pgcrypto.
        <pre><code class="language-sql">-- Установка расширения
CREATE EXTENSION IF NOT EXISTS pgcrypto;
-- Шифрование при вставке
INSERT INTO guest (first_name, passport_number)
VALUES ('Иван', pgp_sym_encrypt('4510 123456', 'strong_encryption_key'));
-- Дешифровка при чтении (только для авторизованных сотрудников)
SELECT first_name, pgp_sym_decrypt(passport_number::bytea, 'strong_encryption_key') FROM guest WHERE guest_id = 1;</code></pre>
    </li>
    <li><strong>Аудит изменений критических данных:</strong> Триггеры автоматически записывают изменения в таблице <code>audit_log</code>.
        <pre><code class="language-sql">CREATE OR REPLACE FUNCTION audit_booking_changes()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'UPDATE' AND NEW.status != OLD.status THEN
        INSERT INTO audit_log (user_id, action, entity_type, entity_id, old_values, new_values)
        VALUES (current_setting('app.current_user_id')::INTEGER,
                'booking_status_change',
                'booking',
                NEW.booking_id,
                jsonb_build_object('status', OLD.status),
                jsonb_build_object('status', NEW.status));
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;</code></pre>
    </li>
    <li><strong>Защита от SQL-инъекций:</strong> В PHP-коде используются только подготовленные выражения (prepared statements) через PDO.
        <pre><code class="language-php">// functions.php - пример безопасного выполнения SQL
function executeSQL($pdo, $sql) {
    // ... проверка на запрещенные операции для не-админов ...
    try {
        $stmt = $pdo->prepare($sql); // PDO автоматически экранирует параметры
        $stmt->execute();
        // ... обработка результата ...
    } catch (PDOException $e) {
        return ['error' => $e->getMessage()];
    }
}</code></pre>
    </li>
    <li><strong>Регулярное обновление и мониторинг:</strong> Настроены оповещения о подозрительной активности (множественные неудачные попытки входа, попытки выполнения DROP-запросов).</li>
</ol>

<h3 id="58-разработка-api-реализующего-работу-с-базой-данных-стороннего-приложения">5.8. Разработка API, реализующего работу с базой данных стороннего приложения</h3>
<p>Для интеграции с мобильным приложением гостя или партнерскими сайтами реализован RESTful API на PHP.</p>

<h4>5.8.1. Базовая структура API (api/index.php)</h4>
<pre><code class="language-php"><?php
// api/index.php
header('Content-Type: application/json');
require_once '../config.php';
require_once '../auth.php';

// Простая маршрутизация
$method = $_SERVER['REQUEST_METHOD'];
$request = explode('/', trim($_SERVER['PATH_INFO'], '/')); // Предполагается настройка mod_rewrite
$endpoint = $request[0] ?? '';

// Аутентификация по API-ключу или JWT-токену (упрощенно)
$apiKey = $_SERVER['HTTP_X_API_KEY'] ?? '';
if (!validateApiKey($pdo, $apiKey)) {
    http_response_code(401);
    echo json_encode(['error' => 'Invalid API key']);
    exit;
}

switch ("$method $endpoint") {
    case 'GET properties':
        echo json_encode(getProperties($pdo, $_GET));
        break;
    case 'POST bookings':
        $data = json_decode(file_get_contents('php://input'), true);
        echo json_encode(createBooking($pdo, $data));
        break;
    case 'GET bookings':
        echo json_encode(getUserBookings($pdo, $userId)); // $userId из токена
        break;
    default:
        http_response_code(404);
        echo json_encode(['error' => 'Endpoint not found']);
}</code></pre>

<h4>5.8.2. Пример endpoint'а для получения списка доступных объектов</h4>
<pre><code class="language-php"><?php
// api/functions.php
function getProperties($pdo, $filters) {
    $query = "SELECT property_id, title, city, district, short_description,
                     area_sq_m, rooms, max_guests, rating,
                     (SELECT MIN(price_per_night) FROM price_calendar pc
                      WHERE pc.property_id = p.property_id AND pc.date >= CURRENT_DATE
                        AND pc.is_blocked = FALSE) as price_from
              FROM property p
              WHERE is_active = TRUE";

    $params = [];
    if (!empty($filters['city'])) {
        $query .= " AND city = ?";
        $params[] = $filters['city'];
    }
    if (!empty($filters['guests'])) {
        $query .= " AND max_guests >= ?";
        $params[] = $filters['guests'];
    }
    // ... добавление других фильтров ...

    $query .= " ORDER BY featured DESC, rating DESC LIMIT 50";
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}
?></code></pre>

<h4>5.8.3. Пример endpoint'а для создания бронирования через API</h4>
<pre><code class="language-php"><?php
function createBooking($pdo, $data) {
    // Валидация входных данных
    $required = ['property_id', 'check_in', 'check_out', 'adults', 'guest_email', 'guest_name'];
    foreach ($required as $field) {
        if (empty($data[$field])) {
            return ['success' => false, 'error' => "Missing field: $field"];
        }
    }

    // 1. Проверка доступности объекта (вызов функции БД)
    $stmt = $pdo->prepare("SELECT is_available FROM check_availability(?, ?, ?)");
    $stmt->execute([$data['property_id'], $data['check_in'], $data['check_out']]);
    if (!$stmt->fetchColumn()) {
        return ['success' => false, 'error' => 'Property not available for these dates'];
    }

    // 2. Поиск или создание гостя
    $guestId = findOrCreateGuest($pdo, $data['guest_email'], $data['guest_name'], $data['guest_phone']);

    // 3. Расчет стоимости (можно вынести в функцию БД)
    // 4. Создание записи бронирования со статусом 'pending' (требует подтверждения)
    $pdo->beginTransaction();
    try {
        $stmt = $pdo->prepare("
            INSERT INTO booking (property_id, guest_id, check_in_date, check_out_date,
                                 adults, children, status, total_price, source)
            VALUES (?, ?, ?, ?, ?, ?, 'pending', ?, 'api')
            RETURNING booking_id, booking_number
        ");
        $totalPrice = calculateTotalPrice($pdo, $data); // Отдельная функция расчета
        $stmt->execute([
            $data['property_id'], $guestId, $data['check_in'], $data['check_out'],
            $data['adults'], $data['children'] ?? 0, $totalPrice
        ]);
        $booking = $stmt->fetch(PDO::FETCH_ASSOC);

        // 5. Отправка уведомления менеджеру (например, через очередь задач)
        // ...

        $pdo->commit();
        return [
            'success' => true,
            'booking_id' => $booking['booking_id'],
            'booking_number' => $booking['booking_number'],
            'message' => 'Booking request created. Manager will contact you for confirmation.'
        ];
    } catch (Exception $e) {
        $pdo->rollBack();
        return ['success' => false, 'error' => 'Database error: ' . $e->getMessage()];
    }
}
?></code></pre>

<h4>5.8.4. Документация API (Swagger/OpenAPI)</h4>
<p>Для разработчиков, интегрирующихся с API, создана документация в формате OpenAPI 3.0 (файл <code>openapi.yaml</code>), которая описывает все endpoint'ы, их параметры, форматы запросов и ответов. Документация может быть развернута с помощью Swagger UI.</p>

<div class="page-break"></div>

<h2 id="заключение">Заключение</h2>

<p>В ходе выполнения курсовой работы была спроектирована, реализована и протестирована комплексная система управления базами данных для агентства по аренде квартир. Были успешно выполнены все поставленные задачи:</p>

<ol>
    <li><strong>Анализ предметной области</strong> позволил четко определить границы системы, выделить ключевые бизнес-процессы (управление объектами, бронирования, финансы, сервис), формализовать входные и выходные данные, а также ограничения предметной области (проверка доступности, финансовые правила).</li>
    <li><strong>Проектирование базы данных</strong> было выполнено по методологии "сверху вниз": от инфологической модели (выделение 21 сущности и их взаимосвязей) через логическую структуру (нормализованные таблицы в 3НФ с элементами денормализации для производительности) к физической реализации в PostgreSQL.</li>
    <li><strong>Реализация в СУБД PostgreSQL</strong> включает создание 25 взаимосвязанных таблиц с корректными типами данных, 15 индексов для оптимизации, 7 триггеров для автоматизации бизнес-правил (генерация номера брони, создание задач на уборку, обновление рейтингов) и набор часто используемых запросов и представлений.</li>
    <li><strong>Веб-интерфейс на PHP и Bootstrap</strong> предоставляет удобный, интуитивный и адаптивный инструмент для работы с данными для пользователей с разными ролями (администратор, менеджер, клинер, гость). Интерфейс включает панель управления с ключевыми метриками, инструменты для просмотра и редактирования данных, встроенный SQL-редактор для администраторов.</li>
    <li><strong>Система безопасности</strong> реализована на нескольких уровнях: аутентификация с хешированием паролей (bcrypt), ролевая модель доступа (RBAC) как на уровне приложения, так и на уровне БД (GRANT/REVOKE), защита от SQL-инъекций через подготовленные выражения, аудит действий пользователей, стратегия резервного копирования с WAL-архивацией и репликацией.</li>
    <li><strong>REST API</strong> обеспечивает возможность интеграции системы с мобильными приложениями, партнерскими сайтами и другими внешними сервисами, открывая пути для масштабирования бизнеса.</li>
    <li><strong>Тестирование и наполнение данными:</strong> База данных заполнена реалистичными тестовыми данными (30+ записей в основных таблицах), что позволило проверить корректность связей, работу триггеров и производительность запросов.</li>
</ol>

<p><strong>Основные результаты и преимущества разработанной системы:</strong></p>
<ul>
    <li><strong>Централизация информации:</strong> Все данные об объектах, клиентах, бронированиях, финансах и задачах хранятся в едином, непротиворечивом хранилище.</li>
    <li><strong>Автоматизация рутинных операций:</strong> Расчет стоимости, проверка доступности, создание задач, отправка уведомлений выполняются автоматически, минимизируя человеческие ошибки.</li>
    <li><strong>Повышение эффективности сотрудников:</strong> Менеджеры получают единую панель для управления всеми процессами, клинеры — четкий график задач.</li>
    <li><strong>Улучшение клиентского сервиса:</strong> Гости могут легко бронировать жилье онлайн, получать автоматические уведомления, оставлять отзывы.</li>
    <li><strong>Инструменты для анализа и принятия решений:</strong> Руководство получает точные отчеты по загрузке, выручке, эффективности в реальном времени.</li>
    <li><strong>Масштабируемость и надежность:</strong> Архитектура базы данных и приложения позволяет наращивать объем данных и пользователей. Стратегия резервного копирования гарантирует сохранность данных.</li>
</ul>

<p><strong>Направления для дальнейшего развития системы:</strong></p>
<ol>
    <li><strong>Интеграция с внешними каналами продаж:</strong> Подключение API Airbnb, Booking.com, Яндекс.Путешествий для синхронизации календаря и цен.</li>
    <li><strong>Внедрение бизнес-аналитики (BI):</strong> Подключение инструментов типа Metabase или Superset для создания интерактивных дашбордов и углубленной аналитики.</li>
    <li><strong>Разработка мобильного приложения для гостей:</strong> Нативное приложение с push-уведомлениями, цифровым ключом (smart lock), чатом с поддержкой.</li>
    <li><strong>Система динамического ценообразования:</strong> Алгоритм, автоматически корректирующий цены в зависимости от спроса, сезона, событий в городе, похожих предложений конкурентов.</li>
    <li><strong>Машинное обучение для рекомендаций:</strong> Рекомендательная система для гостей на основе их предпочтений и поведения похожих пользователей.</li>
    <li><strong>Расширение функционала для владельцев недвижимости:</strong> Личный кабинет владельца с детальной статистикой по его объектам, графиком выплат, возможностью заблокировать даты.</li>
</ol>

<p>Разработанная система является готовым решением, которое может быть внедрено в реальное агентство по аренде квартир. Она сочетает в себе robust backend на PostgreSQL, удобный веб-интерфейс, продуманную безопасность и задел для будущего роста, что полностью соответствует современным требованиям к бизнес-приложениям.</p>

<div class="page-break"></div>

<h2 id="список-использованных-информационных-источников">Список использованных информационных источников</h2>

<ol>
    <li>Официальная документация PostgreSQL 15. [Электронный ресурс]. URL: <a href="https://www.postgresql.org/docs/15/">https://www.postgresql.org/docs/15/</a></li>
    <li>PHP: The Right Way. Современные лучшие практики PHP. [Электронный ресурс]. URL: <a href="https://phptherightway.com/">https://phptherightway.com/</a></li>
    <li>Документация Bootstrap 5. [Электронный ресурс]. URL: <a href="https://getbootstrap.com/docs/5.3/">https://getbootstrap.com/docs/5.3/</a></li>
    <li>Коннолли Т., Бегг К. Базы данных: проектирование, реализация и сопровождение. Теория и практика. – 4-е изд. – М.: Вильямс, 2020. – 1440 с.</li>
    <li>Гарсиа-Молина Г., Ульман Д., Уидом Дж. Системы баз данных. Полный курс. – М.: Вильямс, 2019. – 1088 с.</li>
    <li>Роберт В. Себеста. Основные концепции языков программирования. – 10-е изд. – М.: Вильямс, 2018. – 768 с.</li>
    <li>Вонг Б. MySQL. Оптимизация производительности. – СПб.: Символ-Плюс, 2021. – 832 с. (Принципы применимы и к PostgreSQL).</li>
    <li>Советы по производительности PostgreSQL от команды разработки. [Электронный ресурс]. URL: <a href="https://www.postgresql.org/docs/current/performance-tips.html">https://www.postgresql.org/docs/current/performance-tips.html</a></li>
    <li>OWASP Top Ten. Рекомендации по безопасности веб-приложений. [Электронный ресурс]. URL: <a href="https://owasp.org/www-project-top-ten/">https://owasp.org/www-project-top-ten/</a></li>
    <li>Статьи и руководства на DigitalOcean, Habr, Stack Overflow по темам: «PostgreSQL триггеры», «Ролевая модель доступа», «Резервное копирование БД», «REST API design».</li>
    <li>ГОСТ Р ИСО/МЭК 12207-99. Информационная технология. Процессы жизненного цикла программных средств.</li>
    <li>ГОСТ 19.ххх-79. Единая система программной документации (ЕСПД). Серия стандартов на разработку документации (оператора, программиста, тех. проекта).</li>
</ol>

---

<h2 id="приложения">Приложения</h2>

<h3>Приложение А: Руководство пользователя</h3>
<p><em>Руководство пользователя оформлено в соответствии с ГОСТ 19.505-79 и содержит пошаговые инструкции для каждой роли: как войти в систему, просмотреть объекты, создать бронирование (для гостя), подтвердить бронирование и создать задачу (для менеджера), отметить выполнение уборки (для клинера), работать с отчетами (для администратора). Приведены скриншоты интерфейса.</em></p>

<h3>Приложение Б: Руководство программиста</h3>
    Управление портфелем объектов недвижимости: Ведение каталога (добавление, редактирование, деактивация), загрузка фотогалерей, детальное описание характеристик (площадь, этаж, планировка, удобства), управление динамическим ценообразованием и календарем доступности.
    Взаимодействие с клиентами (гостями): Регистрация гостей на сайте, ведение профилей (паспортные данные, контакты, история бронирований, рейтинг и отзывы), общение через внутреннюю систему сообщений или чат.
    Обработка бронирований и заявок: Прием заявок через сайт, телефон или партнерские каналы; подтверждение брони, расчет стоимости с учетом тарифов, сезонности и длительности проживания; формирование счета и договора.
    Управление финансовыми потоками: Прием оплаты (онлайн-платежи, банковские переводы, наличные), учет депозитов (залогов), обработка возвратов, автоматическое распределение выплат владельцам, формирование финансовой отчетности.
    Организация сервисного обслуживания: Планирование и контроль уборки после каждого гостя, организация текущего ремонта, заказ дополнительных услуг (трансфер, завтрак в номер, экскурсии).
    Контроль качества и безопасность: Сбор и модерация отзывов от гостей, ведение черного списка недобросовестных клиентов, регулярная проверка состояния имущества (инвентаризация), контроль за соблюдением правил проживания.
    Управление персоналом и задачами: Учет сотрудников (менеджеры, риелторы, клинеры, администраторы), назначение задач (показ объекта, встреча гостя, уборка), контроль выполнения, расчет заработной платы.
    Аналитика, отчетность и маркетинг: Формирование статистики по загрузке объектов, выручке, популярности районов и типов жилья; оценка эффективности сотрудников и рекламных каналов; управление промо-акциями и скидками.

1.2. Перечень входных данных

    Данные о владельцах/арендодателях: ФИО (или название компании), контактные данные (телефон, email, адрес), реквизиты для выплат, особые условия сотрудничества.
    Характеристики объектов аренды: Юридический и фактический адрес, тип объекта (квартира, апартаменты, студия, лофт), площадь, этаж, количество комнат, описание, фотографии, список удобств (Wi-Fi, кондиционер, парковка и т.д.).
    Тарифные планы и правила ценообразования: Базовая цена за ночь/месяц, сезонные коэффициенты, скидки за длительное проживание, специальные цены на праздничные даты, минимальный срок аренды.
    Данные о клиентах (гостях): ФИО, паспортные данные, гражданство, дата рождения, email, телефон, предпочтения.
    Данные о сотрудниках агентства: ФИО, должность, отдел, контактные данные, данные для расчета зарплаты, права доступа к системе.
    Заявки на бронирование: Выбранный объект, даты заезда и выезда, количество взрослых и детей, особые пожелания, контактные данные гостя.
    Финансовые операции: Сумма платежа, валюта, способ оплаты, статус, назначение (аренда, депозит, штраф, возврат), данные платежной системы.
    Задачи на обслуживание: Тип задачи (уборка, ремонт, встреча гостя), объект, дата и время, ответственный сотрудник, приоритет, описание.
    Отзывы и рейтинги: Текстовый отзыв, оценки по различным критериям (чистота, расположение, общение с хостом), статус модерации.
    Данные для черного списка: Идентификаторы гостя (ФИО, телефон, паспорт), причина блокировки, дата инцидента, срок блокировки.
    Системные настройки и конфигурация: Время заезда/выезда по умолчанию, процент комиссии агентства, настройки уведомлений (email, SMS), параметры сайта.

1.3. Перечень выходных данных

    Публичный каталог объектов: Страницы с описанием объектов, фотогалереей, календарем доступности и ценами для поиска и бронирования на сайте агентства.
    Подтверждение бронирования (ваучер): Документ с деталями брони для гостя: адрес объекта, даты, правила заезда, контакты поддержки.
    Счета, квитанции и финансовые документы: Счета на оплату, квитанции об оплате, акты выполненных работ для владельцев.
    Отчеты для руководства и владельцев:
        Финансовый отчет (выручка, расходы, прибыль, ожидаемые платежи) за период.
        Отчет по загрузке и доходности объектов (процент занятости, средний доход за ночь, RevPAR).
        Отчет по эффективности сотрудников (количество закрытых сделок, выручка, выполнение задач).
        Отчет по отзывам и рейтингам (средний рейтинг по объектам и агентству в целом).
        Отчет по маркетингу (источники бронирований, конверсия).
    Календарь занятости (Timeline): Визуальное представление занятости каждого объекта на день, неделю, месяц.
    График задач для сотрудников: Ежедневный/еженедельный план для менеджеров, клинеров с указанием времени и места.
    Панель управления (Dashboard): Ведб-интерфейс с ключевыми метриками (KPI) в реальном времени: сегодняшние заезды/выезды, текущая выручка, незавершенные задачи.
    Автоматические уведомления: Email и SMS уведомления для гостей (подтверждение брони, напоминание о заезде, просьба оставить отзыв) и сотрудников (новая заявка, задача, просроченный платеж).
    API-ответы: Данные в формате JSON/XML для интеграции с внешними системами: каналы продаж (Airbnb, Booking.com), бухгалтерские программы (1С), CRM-системы.

1.4. Ограничения предметной области (если таковые имеются)

    Хронологическая целостность: Бронирование не может быть создано на прошедшие даты. Дата и время заезда должны быть позже текущего момента (с учетом времени на подготовку).
    Логическая целостность дат: Дата выезда должна быть строго позже даты заезда. Минимальный срок аренды может быть ограничен (например, 1 ночь для посуточной, 30 дней для долгосрочной).
    Ограничение по вместимости: Количество гостей (взрослых и детей), указанное в бронировании, не может превышать максимальную вместимость, установленную для объекта.
    Финансовые ограничения: Цена аренды, плата за уборку, депозит не могут быть отрицательными. Сумма оплаты не может превышать общую сумму бронирования.
    Уникальность бронирования (контроль коллизий): Один объект недвижимости не может быть забронирован двумя разными гостями на пересекающиеся даты. Система должна проверять доступность перед подтверждением новой брони.
    Ограничения доступа: Гость, внесенный в черный список, не может создать новое бронирование. Попытка бронирования от такого гостя должна блокироваться с уведомлением менеджера.
    Бизнес-правила для услуг: Некоторые услуги (например, глубокая уборка) требуют предварительного бронирования и не могут быть оказаны в день заезда. Количество доступных услуг в день может быть ограничено.
    Правила применения скидок и промокодов: Промокод может иметь ограничение по количеству использований, сроку действия, минимальной сумме заказа или применяться только к определенным объектам или тарифам.
    Правила отмены бронирования: Возврат средств регулируется политикой отмены, которая зависит от времени до заезда. Например, бесплатная отмена за 48 часов, 50% возврат за 24 часа, отсутствие возврата позднее.

1.5. Взаимодействие с другими программами

    Платежные шлюзы и эквайринг (ЮKassa, Тинькофф, Сбербанк): Обмен данными через API для приема онлайн-платежей за бронирования. Получение статуса платежа, инициация возвратов.
    Серверы электронной почты (SMTP): Рассылка автоматических и массовых уведомлений, подтверждений, напоминаний гостям, владельцам и сотрудникам. Использование почтовых сервисов или собственного SMTP.
    Сервисы онлайн-карт (Google Maps API, Yandex Maps API, 2GIS): Отображение объектов на интерактивной карте на сайте, расчет расстояний до достопримечательностей, метро, аэропорта. Геокодирование адресов.
    Облачные хранилища и CDN (Amazon S3, Яндекс.Облако, Selectel): Хостинг фотографий объектов, сканов документов (паспортов, договоров). Обеспечение быстрой загрузки и резервного копирования медиафайлов.
    Внешние каналы продаж и календарные синхронизации (Airbnb API, Booking.com API, Ostrovok.ru): Двусторонняя синхронизация календаря доступности и цен для управления бронированиями из единого интерфейса. Получение заявок и отправка подтверждений.
    Мессенджеры и SMS-шлюзы (Telegram Bot API, WhatsApp Business API, SMS.ru): Отправка уведомлений и общение с гостями через популярные мессенджеры. SMS-напоминания о заезде.
    CRM-системы (Битрикс24, amoCRM, Megaplan): Экспорт данных о клиентах, сделках (бронированиях) и задачах для дальнейшей работы отдела продаж и маркетинга, построения воронки.
    Бухгалтерские системы (1С, «Парус»): Экспорт финансовых данных (платежи, расходы, выплаты владельцам) для ведения бухгалтерского и налогового учета.
    Сервисы аналитики (Google Analytics, Яндекс.Метрика, Mixpanel): Интеграция для отслеживания поведения пользователей на сайте, конверсии бронирований, эффективности рекламных кампаний.

<p><em>Руководство программиста (ГОСТ 19.503-79) включает: общее описание архитектуры системы (клиент-сервер, СУБД PostgreSQL, веб-сервер Apache/PHP), структуру базы данных (полные DDL-скрипты всех таблиц, индексов, триггеров, представлений), описание API (endpoints, форматы запросов/ответов, аутентификация), инструкции по развертыванию среды разработки и production-окружения, рекомендации по расширению системы (добавление новых таблиц, интеграция новых платежных шлюзов).</em></p>

<h3>Приложение В: Код программных модулей</h3>
<p><em>Полный исходный код всех файлов проекта, представленный в техническом задании в начале этого документа, является неотъемлемой частью данной пояснительной записки. Код включает:</em></p>
<ul>
    <li><code>config.php</code> – конфигурация подключения к БД.</li>
    <li><code>auth.php</code>, <code>functions.php</code> – основные функции аутентификации и работы с БД.</li>
    <li><code>index.php</code>, <code>login.php</code>, <code>register.php</code>, <code>logout.php</code>, <code>stats.php</code> – основные PHP-скрипты веб-интерфейса.</li>
    <li><code>style.css</code> – каскадные таблицы стилей.</li>
    <li><code>test.php</code> – скрипт проверки работоспособности системы.</li>
    <li><strong>Полный SQL-скрипт</strong> создания и наполнения базы данных (все CREATE TABLE, INSERT, CREATE INDEX, CREATE TRIGGER).</li>
</ul>
<p><em>Исходный код размещен в Git-репозитории, доступном для проверки.</em></p>
