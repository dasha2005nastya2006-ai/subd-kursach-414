# Документация базы данных "Склад автотоваров"

## 1. Общие сведения
**Название БД:** `autoparts_db`  
**СУБД:** PostgreSQL (версия 12 и выше)  
**Назначение:** Автоматизация складского учета, адресного хранения и контроля движения товаров в магазине автозапчастей.

База данных спроектирована в соответствии с **3-й нормальной формой (3NF)**. Бизнес-логика (пересчет остатков, валидация) вынесена на уровень ядра СУБД (триггеры и ограничения).

---

## 2. Развертывание и установка

### Требования
*   Установленный сервер PostgreSQL.
*   Утилита командной строки `psql` или графический клиент (DBeaver, pgAdmin).

### Инструкция по запуску
1.  Создайте пустую базу данных:
    ```sql
    CREATE DATABASE autoparts_db;
    ```
2.  Выполните SQL-скрипт инициализации (`init.sql`):
    ```bash
    psql -U postgres -d autoparts_db -f init.sql
    ```

---

## 3. Схема данных (Таблицы)

### 3.1. Справочники

#### `categories` (Категории товаров)
Классификатор номенклатуры (например: "Масла", "Фильтры", "Тормозная система").
| Поле | Тип | Описание |
| :--- | :--- | :--- |
| `category_id` | `SERIAL (PK)` | Уникальный идентификатор |
| `name` | `VARCHAR(100)` | Название категории (Unique) |

#### `manufacturers` (Производители)
Справочник брендов. Необходим для обеспечения уникальности артикулов.
| Поле | Тип | Описание |
| :--- | :--- | :--- |
| `manufacturer_id` | `SERIAL (PK)` | Уникальный идентификатор |
| `name` | `VARCHAR(100)` | Название бренда (Unique) |
| `country` | `VARCHAR(50)` | Страна происхождения |

#### `contractors` (Контрагенты)
Единый реестр юридических лиц.
| Поле | Тип | Описание |
| :--- | :--- | :--- |
| `contractor_id` | `SERIAL (PK)` | Уникальный идентификатор |
| `name` | `VARCHAR(150)` | Название организации или ФИО |
| `type` | `VARCHAR(20)` | Тип: `'supplier'` (поставщик) или `'client'` (клиент) |
| `phone`, `email` | `VARCHAR` | Контакты |

---

### 3.2. Основные сущности

#### `products` (Товары)
Центральная таблица. Хранит номенклатуру и **текущее состояние склада**.
| Поле | Тип | Ограничения | Описание |
| :--- | :--- | :--- | :--- |
| `product_id` | `SERIAL (PK)` | | Внутренний ID |
| `part_number` | `VARCHAR` | `NOT NULL` | Артикул производителя |
| `name` | `VARCHAR` | `NOT NULL` | Наименование товара |
| `location_code` | `VARCHAR` | Default: `'RECEPTION'` | Код ячейки адресного хранения (напр. `A-01-12`) |
| `stock_quantity`| `INTEGER` | `CHECK >= 0` | Текущий остаток. **Изменяется только триггерами!** |
| `price` | `NUMERIC` | `CHECK >= 0` | Учетная цена |
| `expiration_date`| `DATE` | | Срок годности (для масел/химии) |
| `category_id` | `INT (FK)` | `SET NULL` | Ссылка на категорию |
| `manufacturer_id`| `INT (FK)` | `SET NULL` | Ссылка на бренд |

#### `stock_movements` (Журнал операций)
Хранит «шапки» документов (накладных).
| Поле | Тип | Описание |
| :--- | :--- | :--- |
| `movement_id` | `SERIAL (PK)` | Номер документа |
| `created_at` | `TIMESTAMP` | Дата создания (автоматически `NOW()`) |
| `operation_type` | `VARCHAR` | Тип: `'in'` (приход), `'out'` (расход), `'writeoff'` (списание) |
| `contractor_id` | `INT (FK)` | Ссылка на контрагента |

#### `movement_items` (Позиции документа)
Детализация накладной. Связывает документ с товарами.
| Поле | Тип | Описание |
| :--- | :--- | :--- |
| `item_id` | `SERIAL (PK)` | ID строки |
| `movement_id` | `INT (FK)` | Ссылка на документ (`CASCADE` при удалении) |
| `product_id` | `INT (FK)` | Ссылка на товар |
| `quantity` | `INTEGER` | Количество в документе |
| `price` | `NUMERIC` | Цена товара на момент операции |

---

## 4. Серверная логика (Автоматизация)

В системе реализован механизм автоматического пересчета остатков для исключения ошибок оператора.

### Триггер: `trg_update_stock`
**Событие:** `AFTER INSERT` на таблице `movement_items`.
**Функция:** `update_stock_on_movement()`
**Логика работы:**
1.  Определяет тип операции из родительской таблицы `stock_movements`.
2.  Если **Приход (`in`)**: Увеличивает `stock_quantity` товара.
3.  Если **Расход/Списание (`out`, `writeoff`)**:
    *   Проверяет, хватает ли товара на складе.
    *   Если товара мало -> **Вызывает исключение** (Ошибка транзакции).
    *   Если хватает -> Уменьшает `stock_quantity`.

---

## 5. API Базы Данных (Хранимые процедуры)

Для безопасности клиентские приложения не должны писать в таблицы напрямую. Взаимодействие осуществляется через вызов процедур (`CALL`).

### 5.1. Регистрация операции
Создает документ движения и позиции, автоматически подтягивая текущую цену товара.
```sql
CALL pr_register_operation(
    _product_id INT,      -- ID товара
    _quantity INT,        -- Количество
    _op_type VARCHAR,     -- 'in', 'out' или 'writeoff'
    _contractor_id INT    -- ID контрагента
);
```

### 5.2. Добавление товара
Безопасное создание новой карточки товара.
```sql
CALL pr_add_product(
    _part_number VARCHAR, -- Артикул
    _name VARCHAR,        -- Название
    _price NUMERIC,       -- Цена
    _location VARCHAR     -- Ячейка (напр. 'B-12')
);
```

---

## 6. Отчетность (Представления / Views)

Для получения данных используйте `SELECT` из подготовленных представлений.

### 6.1. `v_warehouse_stock` (Витрина остатков)
Возвращает сводную таблицу по складу с расшифровкой брендов.
*   **Колонки:** Артикул, Товар, Бренд, Ячейка, Остаток, Цена, Сумма остатка.
*   **Пример:** `SELECT * FROM v_warehouse_stock WHERE "Остаток" > 0;`

### 6.2. `v_expiring_goods` (Монитор сроков годности)
Показывает товары, требующие внимания.
*   **Логика:** Отображает товары, срок годности которых истек или истекает в ближайшие 30 дней.
*   **Статусы:** `'ПРОСРОЧЕНО'`, `'Истекает скоро'`.

### 6.3. `v_movement_history` (История движений)
Полный аудит всех операций.
*   **Колонки:** Дата, Тип операции, Контрагент, Товар, Количество.

---

## 7. Обеспечение целостности и безопасности

1.  **Защита от отрицательных остатков:** Реализована через `CHECK (stock_quantity >= 0)` и логику триггера.
2.  **Денежные типы:** Используется `NUMERIC(10, 2)` для предотвращения ошибок округления `FLOAT`.
3.  **Ссылочная целостность:**
    *   При удалении категории товар не удаляется, поле становится `NULL`.
    *   При удалении накладной все её позиции удаляются автоматически.
4.  **Транзакции:** Все операции через процедуру `pr_register_operation` выполняются в рамках одной транзакции. Если произойдет ошибка (например, нехватка товара), изменения не будут сохранены.

## 8. Резервное копирование

Рекомендуется выполнять ежедневный дамп базы данных:
```bash
# Создание резервной копии
pg_dump -U postgres -h localhost autoparts_db > backup_YYYY_MM_DD.sql

# Восстановление
psql -U postgres -d autoparts_db < backup_YYYY_MM_DD.sql
```
